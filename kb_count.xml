<tool id="kb-python" name="kb-python" version="0.25.1">
	<description> The kb count command runs the kallisto and bustools programs. It can be used for pre-processing of data from a variety of single-cell RNA-seq technologies, and for a number of different workflows (e.g. production of gene count matrices, RNA velocity analyses, etc.).</description>
	<macros>
        	<import>macros.xml</import>
    </macros>
	<requirements>
		<requirement type="package" version="0.25.1">kb-python</requirement>
	</requirements>
	<stdio>
		<exit_code range="1:" />
		<exit_code range=":-1" />
		<regex match="Error:" />
		<regex match="Exception:" />
		<regex match="Exception :" />
	</stdio>
	<command detect_errors="exit_code"><![CDATA[
		mkdir ./index
		&& mkdir ./kb_outs
		#if $refTranscriptSource.TranscriptSource != "indexed":
            && kb ref -i /index/transcriptome.idx 
			-g ./index/transcripts_to_genes.txt 
			-f1 ./index/cdna.fa	
			'${refTranscriptSource.s_index.genomic_fasta}'
			'${refTranscriptSource.s_index.genomic_gtf}'
            #set $index_path = './index'
        #else
            #set $index_path = $refTranscriptSource.index.fields.path
        #end if
		&& kb count -i $index_path/transcriptome.idx  -g $index_path/t2g.txt -x $TECHNOLOGY -o ./kb_outs --h5ad --cellranger $FASTQ1 $FASTQ2
		]]>
	</command>
	<inputs>
		<expand macro="index"/> ## index macro copied from alevin wrapper by bgruening : https://github.com/bgruening/galaxytools/blob/master/tools/salmon/macros.xml
		<param name="TECHNOLOGY" label="Select the scRNA-seq technology:" type="select" multiple="false" format="text" help="Choose the scRNA-seq technology used to generate the fastq data.">
			<option value="10XV1">10XV1</option>
			<option value="10XV2">10XV2</option>
			<option value="10XV3">10XV3</option>
			<option value="CELSEQ">CELSEQ</option>
			<option value="CELSEQ2">CELSEQ2</option>
			<option value="DROPSEQ">DROPSEQ</option>
			<option value="INDROPSV1">INDROPSV1</option>
			<option value="INDROPSV2">INDROPSV2</option>
			<option value="INDROPSV3">INDROPSV3</option>
			<option value="SCRUBSEQ">SCRUBSEQ</option>
			<option value="SURECELL">SURECELL</option>
		</param>
		<param name="FASTQ1" label="Select the R1 fastq file:" type="data" format="fastqsanger.gz" multiple="false"/>
		<param name="FASTQ2" label="Select the R2 fastq file:" type="data" format="fastqsanger.gz" multiple="false"/>  
	</inputs>
        <outputs>
		<data name="h5ad" label="kb-python h5ad file" format="h5" from_work_dir="./kb_outs/counts_unfiltered/adata.h5ad"/>
		<data name="h5ad_genenames" label="kb-python h5ad file filtered for unique gene names" format="h5" from_work_dir="./kb_outs/counts_unfiltered/adata_genenames.h5ad"/>
		<data name="barcodes" label="cellranger barcodes" format="tabular" from_work_dir="./kb_outs/counts_unfiltered/cellranger/barcodes.tsv"/>
		<data name="genes" label="cellranger genes" format="tabular" from_work_dir="./kb_outs/counts_unfiltered/cellranger/genes.tsv"/>
		<data name="matrix" label="cellranger matrix" format="txt" from_work_dir="./kb_outs/counts_unfiltered/cellranger/matrix.mtx" />
		<data name="inspect" label="inspect_report" format="json" from_work_dir="./kb_outs/inspect.json"/>
		<data name="runinfo" label="run info" format="json" from_work_dir="./kb_outs/run_info.json"/>
		<data name="kbinfo" label="kb info" format="json" form_work_dir="./kb_outs/kb_info.json"/>
        </outputs>
</tool>
